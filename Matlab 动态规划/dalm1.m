clear;
LL=[0.7857	0.930804	1.0222	1.081081	1.0069
0.7886	1.047482	1.2072	0.625	1.0069
0.7909	1.077982	0.5849	0.933333	1.007
0.7943	0.991489	0.8967	0.928571	1.007
0.7966	1.018884	0.8213	0.776923	1.0074
0.7989	1.126582	1.1164	1.247525	1.0071
0.8017	1.029963	1.0295	1.126984	1.007
0.804	1.019927	1.0487	0.802817	1.0069
0.8074	1.028571	0.8051	0.947368	1.007
0.8103	1.027778	0.9751	1.037037	1.007
0.8137	1.078649	0.8886	1.017857	1.0069
0.8166	0.983689	0.799	0.894737	1.0067
0.8166	1.059949	0.9788	1.156863	1.0066
0.8211	1.015644	0.6327	0.881356	1.0066
0.824	1.076175	0.6675	0.961538	1.0065
0.8257	0.979052	1.0738	0.8816	1.0067
0.8286	1.048649	1.1343	1.08167	1.0067
0.8314	1.182796	0.945	0.946309	1.0066
0.8314	0.932727	1.056	1.08156	1.0066
0.8343	1.025731	0.8496	1.063934	1.0065
0.8366	0.913416	0.7459	0.893683	1.0067
0.8377	1.011458	1.3892	1.274138	1.0066
0.8411	1.056643	1.208	0.993234	1.0065
0.8429	1.133236	0.886	0.975477	1.0067
0.8434	1.027907	1.0933	1.256983	1.0066
0.8446	0.997235	0.7207	0.783333	1.0066
0.8469	0.959112	1.1864	1.340425	1.0068
0.848	1.011842	0.8653	1.093122	1.0067
0.8503	0.9987	1.0771	1.202323	1.0067
0.8537	0.906128	0.884	0.938084	1.0066
0.856	0.989928	0.9455	0.801648	1.0066
0.8583	1.003198	1.0478	0.963597	1.0063
0.8611	0.943396	0.7583	0.983333	1.0062
0.864	0.956923	1.0668	1.045198	1.0064
0.8657	1.021543	1.3345	1.051784	1.0064
0.8691	1.051719	0.878	0.945626	1.0062
0.8697	0.994003	1.0206	1.073913	1.0061
0.8737	0.975867	1.0456	1.009109	1.0059
0.8737	1.077114	0.9285	1.034102	1.0058
0.8726	1.050891	1.1556	0.980601	1.0057
0.876	1.102873	1.094	1.063304	1.0053
0.8777	1.029814	1.0232	1.116279	1.0052
0.88	0.989144	1.1608	1.058333	1.0055
0.8811	1.041219	0.982	1.14811	1.0058
0.8811	1.026995	1.0235	0.981757	1.0057
0.8817	1.0128	1.0684	1.046886	1.0056
0.884	1.060934	1.0846	1.002674	1.0055
0.884	1.012575	1.0674	1.018333	1.0055
0.8857	1.094506	1.0611	0.92459	1.0054
0.888	1.025769	0.9008	0.921986	1.0052
0.8891	1.011268	1.0177	1.012692	1.0051
0.8909	0.973816	0.8871	0.996956	1.0054
0.8937	0.965484	1.0698	1.025954	1.0056
0.8954	1.048674	1.0595	1.015625	1.0056
0.8971	0.988679	0.8827	0.999633	1.0055
0.8994	1.058969	0.8967	0.996329	1.0054
0.9017	0.994764	0.9648	1.052137	1.0052
0.9034	0.997278	1.0613	0.999649	1.0052
0.9051	0.979072	0.9761	1.003089	1.0052
0.9069	1.075419	1.0304	1.015291	1.0051
0.9091	1.007124	0.9337	1.002072	1.005
0.9103	1.09472	0.9656	0.93246	1.0049
0.9126	1.007103	1.027	1.109941	1.0051
0.9149	0.989812	0.9653	0.903936	1.005
0.9166	1.004751	1.1233	0.97048	1.005
0.9189	1.120758	0.9835	0.834791	1.0049
0.9229	1.013803	1.0037	1.050228	1.005
0.924	0.989719	0.9201	0.956522	1.005
0.9251	1.071428	1.017	1.0525	1.005
0.9309	0.968241	0.9738	1.014719	1.0053
0.932	1.055571	1.0052	1.040102	1.0053
0.9349	0.975566	0.9761	0.985849	1.0053
0.9383	0.998418	1.0847	0.883236	1.0052
0.9417	1.071297	1.0899	1.020774	1.0052
0.9451	1.16391	1.0707	0.955365	1.0053
0.9509	0.95737	0.9668	1.013592	1.0056
0.9514	0.996012	0.9394	0.98659	1.0056
0.9554	1.111581	0.9924	1.008495	1.0056
0.9589	0.9998	0.9155	1.012548	1.0056
0.9617	1.079158	1.2299	1.015253	1.0055
0.964	1.009669	1.045	1.000704	1.0054
0.968	1.01105	1.05	1.098777	1.0054
0.9703	1.062477	1.1152	1.020548	1.0052
0.9743	1.002403	1.0156	0.985529	1.0052
0.9766	1.035103	0.974	1.058874	1.0053
0.9806	1.02316	0.9745	1.018533	1.0052
0.984	1.07122	0.9842	1.04193	1.0052
0.9874	1.009519	1.0474	0.965727	1.0053
0.9909	1.050292	1.0067	0.936909	1.0053
0.9949	0.877033	1.0345	1.072391	1.0056
0.9977	0.885003	1.0381	0.967717	1.0055
1.0006	1.022422	1.1041	0.899919	1.0055
1.004	0.992979	1.0379	0.975588	1.0055
1.0046	1.031907	0.9979	1.003721	1.0054
1.008	0.882291	0.8475	0.878591	1.0053
1.0114	0.886318	0.9661	1.0327	1.0055
1.0143	0.896715	0.9051	0.825641	1.0055
1.0171	0.884065	0.9955	0.755279	1.0057
1.0211	1.046942	0.9877	0.802632	1.0057
1.024	1.003804	1.0643	0.745868	1.0058
1.0274	1.085003	1.0421	1.271468	1.0058
1.0309	0.8055	0.8705	1.20915	1.0059
1.0349	0.809125	0.9454	1.043557	1.006
1.0389	1.106252	1.0937	0.991304	1.006
1.0406	1.066412	0.938	0.840351	1.0061
1.044	0.387675	0.7877	0.505263	1.0074
1.0469	0.50799	0.9308	0.922917	1.0077
1.0503	1.124161	0.9855	0.579684	1.007
1.052	1.008955	0.9184	1.207165	1.0068
1.0543	0.741124	0.9733	0.980645	1.0067
1.0571	0.718563	1.151	1.052632	1.007
1.0577	2.341667	1.1521	1.3	1.007
1.0589	0.841044	0.9576	1.3125	1.0067
1.0611	0.930889	1.0081	0.842527	1.0063
1.0629	1.081818	1.1802	0.999956	1.0059
1.0663	1.295518	0.9814	1.228261	1.0055
1.0691	1.445405	1.0898	1.20354	1.0053
1.0714	0.652206	0.969	1.161765	1.0052
1.0749	1.230504	1.0259	0.810127	1.0053
1.0766	1.097856	1.0231	0.964062	1.0053
1.0794	0.960102	0.9386	0.943274	1.0052
1.0806	1.061008	1.0828	1.202749	1.0053
1.0811	1.200833	1.0699	1.028571	1.0052
1.0834	1.072172	1.0346	1.122222	1.0052
1.0863	0.858252	0.86	0.982426	1.005
1.0874	0.853695	0.9201	0.907029	1.0052
1.0891	1.121908	1.0826	1.027778	1.005
1.092	0.887402	0.8663	0.864865	1.0047
1.0931	1.138421	1.0958	1.0125	1.0047
1.0983	1.137179	1.0438	1.012346	1.0048
1.0983	1.05209	0.8381	0.862774	1.0049
1.0983	1.087296	1.0558	1.003569	1.0051
1.1034	1.013182	1.0455	0.992958	1.0051
1.1034	1.117682	0.8775	1.067376	1.0051
1.104	0.996296	0.924	0.960133	1.005
1.1063	1.020181	1.0216	0.871972	1.005
1.1091	0.997918	0.9589	0.769841	1.0048
1.1097	0.973918	0.9292	1.010309	1.0048
1.1137	0.964649	1.0231	1.045918	1.0048
1.1137	0.737923	0.9812	0.863415	1.0045
1.1149	0.802107	0.9892	0.655367	1.0044
1.1171	1.283302	1.1955	0.887931	1.0045
1.1183	0.887427	1.0059	0.961165	1.0043
1.1183	0.973641	0.97	0.989899	1.0044
1.1189	1.110829	1.0866	1.061224	1.0044
1.12	1.113481	1.012	1.65375	1.0043
1.1229	1.071135	1.0639	1.011629	1.0044
1.1257	1.018519	0.953	0.988563	1.0043
1.1251	0.839498	0.8102	0.848837	1.0042
1.1269	1.090366	1.0514	0.984931	1.0042
1.1291	0.966438	0.9289	0.973505	1.0041
1.1286	1.068746	1.1962	1.000071	1.0041
1.1303	1.051061	1.0008	1.014286	1.004
1.1314	1.012618	0.8979	1.098521	1.0038
1.1343	0.937695	1.1029	1.044939	1.0038
1.1366	1.07309	1.0391	0.920245	1.0039
1.14	1.047059	1.0469	1.0334	1.0039
1.1429	0.948551	1.0139	0.458035	1.004
1.144	1.107855	1.0019	0.704225	1.004
1.1451	1.050647	1.0012	1.02	1.0038
1.1463	1.004821	1.1527	1.198431	1.0039
1.1497	0.954691	1.0091	0.998037	1.0043
1.1514	0.978224	1.0516	1.114754	1.0044
1.1526	1.021689	0.9109	0.893529	1.0045
1.1549	1.058101	1.0052	0.970869	1.0046
1.1571	1.069694	0.9628	0.711985	1.0044
1.16	0.962488	0.9419	0.952381	1.0045
1.1629	0.979487	1.0555	0.62	1.0045
];

%format bank;

x0=100; l0=80;T=12;
%L(:,3)=L(:,6);
%L=L(:,1:5);
L=LL(1:156,:);  % in sample
XL=LL(157:168,:);  % out of sample
pp=size(L);
n1=pp(2);m=pp(1);
I=ones(1,n1);
I1=ones(1,m);

Rb=L(:,2:5)*ones(1,n1-1)'/(n1-1);
XRb=XL(:,2:5)*ones(1,n1-1)'/(n1-1);
Rb1=sort(Rb);

h=m/2;

d=Rb1(m/2)
s1=0;s2=0;

clear L1 L2;
for i=1:m
    if Rb(i)<=d
        Rs(i)=1;
        s1=s1+1;L1(s1,:)=L(i,:);
         rank1(s1)=i;
    end
    if Rb(i)>d
        Rs(i)=2;s2=s2+1;L2(s2,:)=L(i,:);
        rank2(s2)=i;
    end
end
Rs=Rs';
    RR=[Rb Rs];
    %L1,L2,L3,L4
    Rs(m+1)=2;

   for ii=1:6
    clear h L;
    if ii==6
    b=0*L1(:,1);c=b;
   else
           
 b=L1(:,1)*4/2^ii;c=b;
end

    %c=L1(:,1);b=c;
e=L1(:,2:4);
q=L1(:,5);
s=size(L1);
pp=size(L1);
n1=pp(2);m=pp(1);
I1=ones(1,m);
I=ones(1,n1);

%for i=1:n1
    %R(i)=I1*L1(:,i)/m;
%end
%for i=1:m
%for j=1:n1
%M1(i,j)=L1(i,j)-R(j);
%end
%end
%EE=M1'*M1/m;
%EE1(:,:,1)=EE;
%R1(1,:)=R;
I2=ones(1,3);
sk(1)=1+1.970/1200;P=e-sk(1);
c2(1)=c'*c/m;cP(1,:)=c'*P/m;
qP(1,:)=q'*P/m;PP(:,:,1)=P'*P/m;
EP(1,:)=I1*P/m;cq(1)=c'*q/m;
%eb=e0'*b/m,
Ec(1)=I1*c/m;
 q2(1)=q'*q/m;
 q1(1)=I1*q/m;
 b2(1)=b'*b/m;
bP(1,:)=b'*P/m;
bq(1)=b'*q/m;
cb(1)=b'*c/m;
Eb(1)=I1*b/m;

iPP(:,:,1)=inv(PP(:,:,1));
A(1)=EP(1,:)*iPP(:,:,1)*EP(1,:)';
B(1)=qP(1,:)*iPP(:,:,1)*qP(1,:)';
O(1)=qP(1,:)*iPP(:,:,1)*EP(1,:)';
D(1)=Ec(1)-cP(1,:)*iPP(:,:,1)*EP(1,:)';
M(1)=c2(1)-cP(1,:)*iPP(:,:,1)*cP(1,:)';
J(1)=cq(1)-cP(1,:)*iPP(:,:,1)*qP(1,:)';
C(1)=bP(1,:)*iPP(:,:,1)*EP(1,:)';
K(1)=bP(1,:)*iPP(:,:,1)*qP(1,:)';
L(1)=bP(1,:)*iPP(:,:,1)*bP(1,:)';
H(1)=cb(1)-cP(1,:)*iPP(:,:,1)*bP(1,:)';


clear R EE M1 e0 P c b e q I1 I s pp n1I m n1
%L2=L(201:430,:)/5;
%b=L(:,6)*2*l0;
%L2=1+L2;
%L2(:,1)=L2(:,1)+0.04;
%L2(:,3)=L2(:,3)+0.03;
 if ii==6
    b=0*L2(:,1);c=b;
   else
           
 b=L2(:,1)*4/2^ii;c=b;
end
%c=L2(:,1); b=c;
e=L2(:,2:4);
q=L2(:,5);
pp=size(L2);
n1=pp(2);m=pp(1);
I1=ones(1,m);
I=ones(1,n1);
%for i=1:n1
   % R(i)=I1*L2(:,i)/m;
%end
%for i=1:m
%for j=1:n1
%M1(i,j)=L2(i,j)-R(j);
%end
%end
%EE=M1'*M1/m;
%EE1(:,:,2)=EE;
%R(1)=R(1)+0.04;
%R(3)=R(3)+0.03;
%R1(2,:)=R
I2=ones(1,3);
sk(2)=1+2.008/1200;P=e-sk(2);
cP(2,:)=c'*P/m
qP(2,:)=q'*P/m,
bP(2,:)=b'*P/m
PP(:,:,2)=P'*P/m
EP(2,:)=I1*P/m,
%eb=e0'*b/m,
Ec(2)=I1*c/m
c2(2)=c'*c/m,
 q1(2)=I1*q/m
  q2(2)=q'*q/m
  Eb(2)=I1*b/m
  b2(2)=b'*b/m
cb(2)=b'*c/m
bq(2)=b'*q/m
 cq(2)=c'*q/m
iPP(:,:,2)=inv(PP(:,:,2))
A(2)=EP(2,:)*iPP(:,:,2)*EP(2,:)'
B(2)=qP(2,:)*iPP(:,:,2)*qP(2,:)'
O(2)=qP(2,:)*iPP(:,:,2)*EP(2,:)'
C(2)=bP(2,:)*iPP(:,:,2)*EP(2,:)'
K(2)=bP(2,:)*iPP(:,:,2)*qP(2,:)'
L(2)=bP(2,:)*iPP(:,:,2)*bP(2,:)'
H(2)=cb(2)-cP(2,:)*iPP(:,:,2)*bP(2,:)'
D(2)=Ec(2)-cP(2,:)*iPP(:,:,2)*EP(2,:)'
M(2)=c2(2)-cP(2,:)*iPP(:,:,2)*cP(2,:)'
J(2)=cq(2)-cP(2,:)*iPP(:,:,2)*qP(2,:)'

sr1=zeros(1,2);sr2=zeros(1,2);
for i=1:s1
    if Rs(rank1(i)+1)==1
    sr1(1)=sr1(1)+1;
    end
    if Rs(rank1(i)+1)==2
    sr1(2)=sr1(2)+1;
    end
end

for i=1:s2
    if Rs(rank2(i)+1)==1
    sr2(1)=sr2(1)+1;
    end
    if Rs(rank2(i)+1)==2
    sr2(2)=sr2(2)+1;
    end
end
%sr1(2)=sr1(2)+1;
s1,sr1,s2,sr2,
Z=[sr1/s1;sr2/s2]

I3=[1;1];O2=[0;0];
w(:,T+1)=2*I3;lan(:,T+1)=-2*I3;n(:,T+1)=2*I3;
gama(:,T+1)=I3;f(:,T+1)=-2*I3;phi(:,T+1)=O2;
h(:,T+1)=O2;g(:,T+1)=O2;theta(:,T+1)=O2;psi(:,T+1)=O2;
 for k=1:T
     wba(:,T+2-k)=Z*w(:,T+2-k);lanba(:,T+2-k)=Z*lan(:,T+2-k);
     nba(:,T+2-k)=Z*n(:,T+2-k);gamaba(:,T+2-k)=Z*gama(:,T+2-k);
     fba(:,T+2-k)=Z*f(:,T+2-k);phiba(:,T+2-k)=Z*phi(:,T+2-k);
     hba(:,T+2-k)=Z*h(:,T+2-k);gba(:,T+2-k)=Z*g(:,T+2-k);
     thetaba(:,T+2-k)=Z*theta(:,T+2-k);psiba(:,T+2-k)=Z*psi(:,T+2-k);
     for i=1:2
         w(i,T+1-k)=wba(i,T+2-k)*(1-A(i))*sk(i)^2;
         lan(i,T+1-k)=lanba(i,T+2-k)*(q1(i)-O(i))*sk(i);
         n(i,T+1-k)=nba(i,T+2-k)*(1-A(i))*sk(i);
         gama(i,T+1-k)=gamaba(i,T+2-k)*q2(i)-0.5*lanba(i,T+2-k)^2*B(i)/wba(i,T+2-k);
         f(i,T+1-k)=fba(i,T+2-k)*q1(i)-lanba(i,T+2-k)*nba(i,T+2-k)*O(i)/wba(i,T+2-k);
         phi(i,T+1-k)=phiba(i,T+2-k)-0.5*nba(i,T+2-k)^2*A(i)/wba(i,T+2-k);
         h(i,T+1-k)=(hba(i,T+2-k)*(1-A(i))+wba(i,T+2-k)*D(i)+lanba(i,T+2-k)*(Eb(i)-C(i)))*sk(i);
         g(i,T+1-k)=gba(i,T+2-k)*q1(i)+2*gamaba(i,T+2-k)*bq(i)+lanba(i,T+2-k)*(J(i)-hba(i,T+2-k)*O(i)/wba(i,T+2-k)-lanba(i,T+2-k)*K(i)/wba(i,T+2-k));
         theta(i,T+1-k)=thetaba(i,T+2-k)+nba(i,T+2-k)*D(i)+fba(i,T+2-k)*Eb(i)-hba(i,T+2-k)*nba(i,T+2-k)*A(i)/wba(i,T+2-k)-lanba(i,T+2-k)*nba(i,T+2-k)*C(i)/wba(i,T+2-k);
         psi(i,T+1-k)=psiba(i,T+2-k)+0.5*wba(i,T+2-k)*M(i)+hba(i,T+2-k)*D(i)-0.5*hba(i,T+2-k)^2*A(i)/wba(i,T+2-k)+lanba(i,T+2-k)*H(i)+gamaba(i,T+2-k)*b2(i)-0.5*lanba(i,T+2-k)^2*L(i)/wba(i,T+2-k)+gba(i,T+2-k)*Eb(i)-lanba(i,T+2-k)*hba(i,T+2-k)*C(i)/wba(i,T+2-k);
     end
 end

 clear a umin vmin ud w0 h0 lan0 n0 gama0 g0 i f0 phi0 psi0 theta0;
 %w,lan,n, h,gama,f,phi,g,psi,theta
 w0=w(:,1);h0=h(:,1);
 lan0=lan(:,1);
 n0=n(:,1);gama0=gama(:,1);g0=g(:,1);
 f0=f(:,1);phi0=phi(:,1);psi0=psi(:,1);
 theta0=theta(:,1);
 i=2; % 只考虑牛市市场状态情形
 X1(:,i)=-iPP(:,:,i)*qP(i,:)',
 lw=lanba(:,2:T+1)./wba(:,2:T+1)
 X2(:,i)=-iPP(:,:,i)*bP(i,:)',
 X3(:,i)=-iPP(:,:,i)*cP(i,:)'
 X4(:,i)=-iPP(:,:,i)*EP(i,:)'
 sk
 hw=hba(:,2:T+1)./wba(:,2:T+1);
 nw=nba(:,2:T+1)./wba(:,2:T+1);
 nw=nba(:,2:T+1)./wba(:,2:T+1);
 ud(i)=n0(i)*x0+f0(i)*l0+theta0(i);
 phi02=2*phi0,
 a(i)=-(1+phi0(i))./phi0(i)
 umin(i)=ud(i)./(2+2*phi0(i)),
 vmin(i)=0.5*w0(i)*x0^2+lan0(i)*x0*l0+gama0(i)*(l0)^2+h0(i)*x0+g0(i)*l0+psi0(i)-0.25*ud(i)^2./(1+phi0(i)),
 %coex2=0.5*(w0(i)-0.5*n0(i)^2/(1+phi0(i)));
 %coexl=lan0(i)-0.5*n0(i)*f0(i)/(1+phi0(i));
 %coel2=gama0(i)-0.25*f0(i)^2/(1+phi0(i));
%coex=h0(i)-0.5*n0(i)*theta0(i)/(1+phi0(i));
 %coel=g0(i)-0.5*f0(i)*theta0(i)/(1+phi0(i));
 %coe=psi0(i)-0.25*theta0(i)^2/(1+phi0(i));
 
  %wba, lanba, hba
 %axis([2^2 13^2 1.5 4.6])
%xlabel('Standard   deviation ');ylabel('Mean ');
x(ii,:)=linspace(umin(i),umin(i)+5,100);
%y1=sqrt(a*(x1-umin).^2+vmin);
y(ii,:)=a(i)*(x(ii,:)-umin(i)).^2+vmin(i);


   end
  hold on;box on;
xlabel('Variance');ylabel('Mean ');

plot(y(1,:),x(1,:),'c+'),
plot(y(2,:),x(2,:),'g-','linewidth',3),
plot(y(3,:),x(3,:),'mo'),
plot(y(4,:),x(4,:),'k.','linewidth',2),
plot(y(5,:),x(5,:),'b--','linewidth',2),
plot(y(6,:),x(6,:),'r-.','linewidth',2),
legend('b^*=2b and c^*=2c','b^*=b and c^*=c','b^*=b/2 and c^*=c/2','b^*=b/4 and c^*=c/4','b^*=b/8 and c^*=c/8','b^*=0 and c^*=0',4)
%legend('\xi_0=1 (bearish)','\xi_0=2 (bullish)',4);
axis([0.009 0.02 16 21.5])
